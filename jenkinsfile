pipeline { 
    agent any 
     
    environment { 
        PYTHON_VERSION = '3.12' 
    } 
     
    stages { 
        stage('Checkout') { 
            steps { 
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/sabarichandruc/playwright_tests.git'
                    ]]
                ])
            } 
        } 
         
        stage('Setup Python Environment') { 
            steps { 
                sh ''' 
                    set -e
                    python3 -m venv venv 
                    . venv/bin/activate 
                    pip install --upgrade pip setuptools wheel
                    pip install -r requirement.txt 
                ''' 
            } 
        } 
         
        stage('Install Playwright Browsers') { 
            steps { 
                sh ''' 
                    . venv/bin/activate 
                    playwright install chromium 
                    playwright install-deps chromium 
                ''' 
            } 
        } 
         
        stage('Run Tests') { 
            steps { 
                sh ''' 
                    . venv/bin/activate 
                    pytest tests/ 
                ''' 
            } 
        } 
    } 
     
    post { 
        always { 
            publishHTML([ 
                allowMissing: true, 
                alwaysLinkToLastBuild: true, 
                keepAll: true, 
                reportDir: 'test-report', 
                reportFiles: 'report.html', 
                reportName: 'Playwright Test Report' 
            ]) 
             
            junit(allowEmptyResults: true, testResults: 'reports/**/*.xml') 
            
            archiveArtifacts(artifacts: 'screenshots/**/*.png,videos/**/*.mp4', allowEmptyArchive: true)
            
            cleanWs() 
        } 
         
        success { 
            echo 'Tests passed successfully!' 
        } 
         
        failure { 
            echo 'Tests failed!' 
        } 
    } 
}